name: Planechase CD

on:
    workflow_dispatch:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    audit:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v2

            -   uses: actions/setup-node@v2
                with:
                    node-version: '14'

            -   name: Audit
                run: npm audit

    test:
        needs: [ audit ]

        runs-on: ubuntu-latest

        steps:
            -   uses: actions/checkout@v2

            -   uses: actions/setup-node@v2
                with:
                    node-version: '14'

            -   name: Install packages
                run: npm ci

            -   name: Lint
                run: npm run lint

    build-image:
        needs: [ test ]

        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v2

            -   uses: actions/setup-node@v2
                with:
                    node-version: '14'

            -   name: Install packages
                run: npm ci

            -   name: Build
                run: npm run build:production

            -   name: Build image
                run: docker build -t docker.saturnserver.org/planechase/planechase:latest .

            -   name: Login to Docker Registry
                uses: docker/login-action@v1
                with:
                    registry: docker.saturnserver.org
                    username: ${{ secrets.REGISTRY_USER }}
                    password: ${{ secrets.REGISTRY_PASSWORD }}

            -   name: Push image
                run: docker push docker.saturnserver.org/planechase/planechase:latest

    deploy:
        needs: [ build-image ]

        runs-on: ubuntu-latest
        steps:
            -   uses: actions/setup-node@v2
                with:
                    node-version: '14'

            -   name: Deploy
                if: github.event_name == 'push'
                run: npx -q @ionaru/teamcity-deploy teamcity.saturnserver.org Planechase_Deploy ${{ secrets.TEAMCITY_TOKEN }}
